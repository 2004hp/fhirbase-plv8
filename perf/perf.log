
2016-03-22 13:37:10 EDT [23917-2] LOG:  received fast shutdown request
2016-03-22 13:37:10 EDT [23917-3] LOG:  aborting any active transactions
2016-03-22 13:37:10 EDT [23922-2] LOG:  autovacuum launcher shutting down
2016-03-22 13:37:10 EDT [23919-1] LOG:  shutting down
2016-03-22 13:37:10 EDT [23919-2] LOG:  database system is shut down
2016-03-22 13:37:11 EDT [24523-1] LOG:  database system was shut down at 2016-03-22 13:37:10 EDT
2016-03-22 13:37:11 EDT [24523-2] LOG:  MultiXact member wraparound protections are now enabled
2016-03-22 13:37:11 EDT [24522-1] LOG:  database system is ready to accept connections
2016-03-22 13:37:11 EDT [24527-1] LOG:  autovacuum launcher started
2016-03-22 13:37:11 EDT [24529-1] [unknown]@[unknown] LOG:  incomplete startup packet
2016-03-22 13:37:12 EDT [24532-1] postgres@postgres LOG:  statement: SELECT d.datname as "Name",
	       pg_catalog.pg_get_userbyid(d.datdba) as "Owner",
	       pg_catalog.pg_encoding_to_char(d.encoding) as "Encoding",
	       d.datcollate as "Collate",
	       d.datctype as "Ctype",
	       pg_catalog.array_to_string(d.datacl, E'\n') AS "Access privileges"
	FROM pg_catalog.pg_database d
	ORDER BY 1;
2016-03-22 13:37:12 EDT [24532-2] postgres@postgres LOG:  duration: 1.570 ms
2016-03-22 13:37:12 EDT [24535-1] postgres@postgres LOG:  statement: SELECT d.datname as "Name",
	       pg_catalog.pg_get_userbyid(d.datdba) as "Owner",
	       pg_catalog.pg_encoding_to_char(d.encoding) as "Encoding",
	       d.datcollate as "Collate",
	       d.datctype as "Ctype",
	       pg_catalog.array_to_string(d.datacl, E'\n') AS "Access privileges"
	FROM pg_catalog.pg_database d
	ORDER BY 1;
2016-03-22 13:37:12 EDT [24535-2] postgres@postgres LOG:  duration: 1.021 ms
2016-03-22 13:37:13 EDT [24538-1] postgres@postgres LOG:  statement: SELECT d.datname as "Name",
	       pg_catalog.pg_get_userbyid(d.datdba) as "Owner",
	       pg_catalog.pg_encoding_to_char(d.encoding) as "Encoding",
	       d.datcollate as "Collate",
	       d.datctype as "Ctype",
	       pg_catalog.array_to_string(d.datacl, E'\n') AS "Access privileges"
	FROM pg_catalog.pg_database d
	ORDER BY 1;
2016-03-22 13:37:13 EDT [24538-2] postgres@postgres LOG:  duration: 1.543 ms
2016-03-22 13:37:18 EDT [24575-1] fhirbase@postgres LOG:  statement: DROP DATABASE IF EXISTS fhirbase;
2016-03-22 13:37:18 EDT [24575-2] fhirbase@postgres LOG:  duration: 0.182 ms
2016-03-22 13:37:18 EDT [24585-1] fhirbase@postgres LOG:  statement: CREATE DATABASE fhirbase WITH OWNER fhirbase ENCODING = 'UTF8';
2016-03-22 13:37:19 EDT [24585-2] fhirbase@postgres LOG:  duration: 239.571 ms
2016-03-22 13:37:19 EDT [24595-1] fhirbase@fhirbase LOG:  statement: CREATE SCHEMA IF NOT EXISTS perf;
2016-03-22 13:37:19 EDT [24595-2] fhirbase@fhirbase LOG:  duration: 0.733 ms
2016-03-22 13:37:19 EDT [24608-1] fhirbase@fhirbase LOG:  statement: SET search_path TO perf;
2016-03-22 13:37:19 EDT [24608-2] fhirbase@fhirbase LOG:  duration: 0.150 ms
2016-03-22 13:37:20 EDT [24621-1] fhirbase@fhirbase LOG:  statement: SET search_path TO perf;
2016-03-22 13:37:20 EDT [24621-2] fhirbase@fhirbase LOG:  duration: 0.166 ms
2016-03-22 13:37:20 EDT [24621-3] fhirbase@fhirbase LOG:  statement: DROP TABLE IF EXISTS first_names;
2016-03-22 13:37:20 EDT [24621-4] fhirbase@fhirbase LOG:  duration: 0.387 ms
2016-03-22 13:37:20 EDT [24621-5] fhirbase@fhirbase LOG:  statement: DROP TABLE IF EXISTS last_names;
2016-03-22 13:37:20 EDT [24621-6] fhirbase@fhirbase LOG:  duration: 0.172 ms
2016-03-22 13:37:20 EDT [24621-7] fhirbase@fhirbase LOG:  statement: DROP TABLE IF EXISTS languages;
2016-03-22 13:37:20 EDT [24621-8] fhirbase@fhirbase LOG:  duration: 0.182 ms
2016-03-22 13:37:20 EDT [24621-9] fhirbase@fhirbase LOG:  statement: DROP TABLE IF EXISTS street_names;
2016-03-22 13:37:20 EDT [24621-10] fhirbase@fhirbase LOG:  duration: 0.200 ms
2016-03-22 13:37:20 EDT [24621-11] fhirbase@fhirbase LOG:  statement: DROP TABLE IF EXISTS cities;
2016-03-22 13:37:20 EDT [24621-12] fhirbase@fhirbase LOG:  duration: 0.179 ms
2016-03-22 13:37:20 EDT [24621-13] fhirbase@fhirbase LOG:  statement: DROP TABLE IF EXISTS organization_names;
2016-03-22 13:37:20 EDT [24621-14] fhirbase@fhirbase LOG:  duration: 0.200 ms
2016-03-22 13:37:20 EDT [24621-15] fhirbase@fhirbase LOG:  statement: CREATE TABLE first_names (
	  sex text,
	  first_name text
	);
2016-03-22 13:37:20 EDT [24621-16] fhirbase@fhirbase LOG:  duration: 8.993 ms
2016-03-22 13:37:20 EDT [24621-17] fhirbase@fhirbase LOG:  statement: CREATE TABLE last_names (
	  last_name text
	);
2016-03-22 13:37:20 EDT [24621-18] fhirbase@fhirbase LOG:  duration: 2.079 ms
2016-03-22 13:37:20 EDT [24621-19] fhirbase@fhirbase LOG:  statement: CREATE TABLE languages (
	  code text,
	  name text
	);
2016-03-22 13:37:20 EDT [24621-20] fhirbase@fhirbase LOG:  duration: 1.951 ms
2016-03-22 13:37:20 EDT [24621-21] fhirbase@fhirbase LOG:  statement: CREATE TABLE street_names (
	  street_name text
	);
2016-03-22 13:37:20 EDT [24621-22] fhirbase@fhirbase LOG:  duration: 1.710 ms
2016-03-22 13:37:20 EDT [24621-23] fhirbase@fhirbase LOG:  statement: CREATE TABLE cities (
	  zip text,
	  state text,
	  city text,
	  latitude float,
	  longitude float
	);
2016-03-22 13:37:20 EDT [24621-24] fhirbase@fhirbase LOG:  duration: 1.731 ms
2016-03-22 13:37:20 EDT [24621-25] fhirbase@fhirbase LOG:  statement: CREATE TABLE organization_names (
	  organization_name text
	);
2016-03-22 13:37:20 EDT [24621-26] fhirbase@fhirbase LOG:  duration: 1.735 ms
2016-03-22 13:37:20 EDT [24621-27] fhirbase@fhirbase LOG:  statement: DROP FUNCTION IF EXISTS load_dummy_data() CASCADE;
2016-03-22 13:37:20 EDT [24621-28] fhirbase@fhirbase LOG:  duration: 0.256 ms
2016-03-22 13:37:20 EDT [24621-29] fhirbase@fhirbase LOG:  statement: CREATE OR REPLACE FUNCTION load_dummy_data()
	RETURNS void AS $$
	  BEGIN
	    RAISE NOTICE 'Load fake "first_names".';
	    COPY first_names (sex, first_name) FROM '/fhirbase/perf/data/first_names.csv';
	
	    RAISE NOTICE 'Load fake "last_names".';
	    COPY last_names (last_name) FROM '/fhirbase/perf/data/last_names.csv';
	
	    RAISE NOTICE 'Load fake "languages".';
	    COPY languages (code, name) FROM '/fhirbase/perf/data/language-codes-iso-639-1-alpha-2.csv' WITH csv;
	
	    RAISE NOTICE 'Load fake "street_names".';
	    COPY street_names (street_name) FROM '/fhirbase/perf/data/street_names.csv';
	
	    RAISE NOTICE 'Load fake "cities".';
	    COPY cities (zip, state, city, latitude, longitude) FROM '/fhirbase/perf/data/cities.csv' WITH csv;
	
	    RAISE NOTICE 'Load fake "organization_names".';
	    COPY organization_names (organization_name) FROM '/fhirbase/perf/data/organization_names.csv';
	  END
	$$ LANGUAGE plpgsql;
2016-03-22 13:37:20 EDT [24621-30] fhirbase@fhirbase LOG:  duration: 2.350 ms
2016-03-22 13:37:20 EDT [24631-1] fhirbase@fhirbase LOG:  statement: SET search_path TO perf;
2016-03-22 13:37:20 EDT [24631-2] fhirbase@fhirbase LOG:  duration: 0.165 ms
2016-03-22 13:37:20 EDT [24631-3] fhirbase@fhirbase LOG:  statement: SELECT load_dummy_data();
2016-03-22 13:37:20 EDT [24631-4] fhirbase@fhirbase LOG:  duration: 152.318 ms
2016-03-22 13:37:20 EDT [24641-1] fhirbase@fhirbase LOG:  statement: SET search_path TO perf;
2016-03-22 13:37:20 EDT [24641-2] fhirbase@fhirbase LOG:  duration: 0.149 ms
2016-03-22 13:37:20 EDT [24641-3] fhirbase@fhirbase LOG:  statement: SET plv8.start_proc = 'plv8_init';
2016-03-22 13:37:20 EDT [24641-4] fhirbase@fhirbase LOG:  duration: 0.117 ms
2016-03-22 13:37:20 EDT [24641-5] fhirbase@fhirbase LOG:  statement: SELECT fhir_create_storage('{"resourceType": "Organization"}'::json);
2016-03-22 13:37:20 EDT [24641-6] fhirbase@fhirbase ERROR:  function fhir_create_storage(json) does not exist at character 8
2016-03-22 13:37:20 EDT [24641-7] fhirbase@fhirbase HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
2016-03-22 13:37:20 EDT [24641-8] fhirbase@fhirbase STATEMENT:  SELECT fhir_create_storage('{"resourceType": "Organization"}'::json);
2016-03-22 13:37:20 EDT [24641-9] fhirbase@fhirbase LOG:  statement: SELECT fhir_create_storage('{"resourceType": "Encounter"}'::json);
2016-03-22 13:37:20 EDT [24641-10] fhirbase@fhirbase ERROR:  function fhir_create_storage(json) does not exist at character 8
2016-03-22 13:37:20 EDT [24641-11] fhirbase@fhirbase HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
2016-03-22 13:37:20 EDT [24641-12] fhirbase@fhirbase STATEMENT:  SELECT fhir_create_storage('{"resourceType": "Encounter"}'::json);
2016-03-22 13:37:20 EDT [24641-13] fhirbase@fhirbase LOG:  statement: SELECT fhir_create_storage('{"resourceType": "Practitioner"}'::json);
2016-03-22 13:37:20 EDT [24641-14] fhirbase@fhirbase ERROR:  function fhir_create_storage(json) does not exist at character 8
2016-03-22 13:37:20 EDT [24641-15] fhirbase@fhirbase HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
2016-03-22 13:37:20 EDT [24641-16] fhirbase@fhirbase STATEMENT:  SELECT fhir_create_storage('{"resourceType": "Practitioner"}'::json);
2016-03-22 13:37:20 EDT [24641-17] fhirbase@fhirbase LOG:  statement: SELECT fhir_create_storage('{"resourceType": "Patient"}'::json);
2016-03-22 13:37:20 EDT [24641-18] fhirbase@fhirbase ERROR:  function fhir_create_storage(json) does not exist at character 8
2016-03-22 13:37:20 EDT [24641-19] fhirbase@fhirbase HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
2016-03-22 13:37:20 EDT [24641-20] fhirbase@fhirbase STATEMENT:  SELECT fhir_create_storage('{"resourceType": "Patient"}'::json);
2016-03-22 13:37:20 EDT [24652-1] fhirbase@fhirbase LOG:  statement: SET search_path TO perf;
2016-03-22 13:37:20 EDT [24652-2] fhirbase@fhirbase LOG:  duration: 0.148 ms
2016-03-22 13:37:20 EDT [24652-3] fhirbase@fhirbase LOG:  statement: DROP FUNCTION IF EXISTS random(a numeric, b numeric) CASCADE;
2016-03-22 13:37:20 EDT [24652-4] fhirbase@fhirbase LOG:  duration: 0.308 ms
2016-03-22 13:37:20 EDT [24652-5] fhirbase@fhirbase LOG:  statement: CREATE OR REPLACE FUNCTION random(a numeric, b numeric)
	RETURNS numeric AS $$
	  SELECT ceil(a + (b - a) * random())::numeric;
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-6] fhirbase@fhirbase LOG:  duration: 1.793 ms
2016-03-22 13:37:20 EDT [24652-7] fhirbase@fhirbase LOG:  statement: DROP FUNCTION IF EXISTS random_elem(a anyarray) CASCADE;
2016-03-22 13:37:20 EDT [24652-8] fhirbase@fhirbase LOG:  duration: 0.158 ms
2016-03-22 13:37:20 EDT [24652-9] fhirbase@fhirbase LOG:  statement: CREATE OR REPLACE FUNCTION random_elem(a anyarray)
	RETURNS anyelement AS $$
	  SELECT a[1 + floor(RANDOM() * array_length(a, 1))];
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-10] fhirbase@fhirbase LOG:  duration: 0.371 ms
2016-03-22 13:37:20 EDT [24652-11] fhirbase@fhirbase LOG:  statement: DROP FUNCTION IF EXISTS random_date() CASCADE;
2016-03-22 13:37:20 EDT [24652-12] fhirbase@fhirbase LOG:  duration: 0.137 ms
2016-03-22 13:37:20 EDT [24652-13] fhirbase@fhirbase LOG:  statement: CREATE OR REPLACE FUNCTION random_date()
	RETURNS text AS $$
	  SELECT random(1900, 2010)::text
	           || '-'
	           || lpad(random(1, 12)::text, 2, '0')
	           || '-'
	           || lpad(random(1, 28)::text, 2, '0');
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-14] fhirbase@fhirbase LOG:  duration: 0.480 ms
2016-03-22 13:37:20 EDT [24652-15] fhirbase@fhirbase LOG:  statement: DROP FUNCTION IF EXISTS random_phone() CASCADE;
2016-03-22 13:37:20 EDT [24652-16] fhirbase@fhirbase LOG:  duration: 0.137 ms
2016-03-22 13:37:20 EDT [24652-17] fhirbase@fhirbase LOG:  statement: CREATE OR REPLACE FUNCTION random_phone()
	RETURNS text AS $$
	  SELECT '+' || random(1, 12)::text ||
	         ' (' || random(1, 999)::text || ') ' ||
	         lpad(random(1, 999)::text, 3, '0') ||
	         '-' ||
	         lpad(random(1, 99)::text, 2, '0') ||
	         '-' ||
	         lpad(random(1, 99)::text, 2, '0')
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-18] fhirbase@fhirbase LOG:  duration: 0.403 ms
2016-03-22 13:37:20 EDT [24652-19] fhirbase@fhirbase LOG:  statement: DROP FUNCTION IF EXISTS make_address(_street_name_ text, _zip_ text, _city_ text, _state_ text) CASCADE;
2016-03-22 13:37:20 EDT [24652-20] fhirbase@fhirbase LOG:  duration: 0.155 ms
2016-03-22 13:37:20 EDT [24652-21] fhirbase@fhirbase LOG:  statement: CREATE OR REPLACE FUNCTION make_address(_street_name_ text, _zip_ text, _city_ text, _state_ text)
	RETURNS jsonb AS $$
	  select array_to_json(ARRAY[
	    json_build_object(
	      'use', 'home',
	      'line', ARRAY[_street_name_ || ' ' || random(0, 100)::text],
	      'city', _city_,
	      'postalCode', _zip_::text,
	      'state', _state_,
	      'country', 'US'
	    )
	  ])::jsonb;
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-22] fhirbase@fhirbase LOG:  duration: 0.524 ms
2016-03-22 13:37:20 EDT [24652-23] fhirbase@fhirbase LOG:  statement: DROP FUNCTION IF EXISTS insert_organizations() CASCADE;
2016-03-22 13:37:20 EDT [24652-24] fhirbase@fhirbase LOG:  duration: 0.168 ms
2016-03-22 13:37:20 EDT [24652-25] fhirbase@fhirbase LOG:  statement: CREATE OR REPLACE FUNCTION insert_organizations()
	RETURNS bigint AS $$
	  with organizations_source as (
	    select organization_name, row_number() over ()
	    from organization_names
	    order by random()
	  ), street_names_source as (
	    select street_name, row_number() over ()
	    from street_names
	    order by random()
	  ), cities_source as (
	    select city, zip, state, row_number() over ()
	    from cities
	    order by random()
	  ), organization_data as (
	    select *,
	           random_phone() as phone
	    from organizations_source
	    join street_names_source using (row_number)
	    join cities_source using (row_number)
	  ), inserted as (
	    INSERT into organization (id, version_id, resource)
	    SELECT obj->>'id', obj#>>'{meta,versionId}', obj
	    FROM (
	      SELECT
	        json_build_object(
	         'resourceType', 'Organization',
	         'id', gen_random_uuid(),
	         'name', organization_name,
	         'telecom', ARRAY[
	           json_build_object(
	            'system', 'phone',
	            'value', phone,
	            'use', 'work'
	           )
	         ],
	         'address', make_address(street_name, zip, city, state)
	        )::jsonb as obj
	        FROM organization_data
	    ) _
	    RETURNING id
	  )
	  select count(*) inserted;
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-26] fhirbase@fhirbase ERROR:  relation "organization" does not exist at character 669
2016-03-22 13:37:20 EDT [24652-27] fhirbase@fhirbase STATEMENT:  CREATE OR REPLACE FUNCTION insert_organizations()
	RETURNS bigint AS $$
	  with organizations_source as (
	    select organization_name, row_number() over ()
	    from organization_names
	    order by random()
	  ), street_names_source as (
	    select street_name, row_number() over ()
	    from street_names
	    order by random()
	  ), cities_source as (
	    select city, zip, state, row_number() over ()
	    from cities
	    order by random()
	  ), organization_data as (
	    select *,
	           random_phone() as phone
	    from organizations_source
	    join street_names_source using (row_number)
	    join cities_source using (row_number)
	  ), inserted as (
	    INSERT into organization (id, version_id, resource)
	    SELECT obj->>'id', obj#>>'{meta,versionId}', obj
	    FROM (
	      SELECT
	        json_build_object(
	         'resourceType', 'Organization',
	         'id', gen_random_uuid(),
	         'name', organization_name,
	         'telecom', ARRAY[
	           json_build_object(
	            'system', 'phone',
	            'value', phone,
	            'use', 'work'
	           )
	         ],
	         'address', make_address(street_name, zip, city, state)
	        )::jsonb as obj
	        FROM organization_data
	    ) _
	    RETURNING id
	  )
	  select count(*) inserted;
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-28] fhirbase@fhirbase LOG:  statement: DROP FUNCTION IF EXISTS insert_practitioners(_total_count_ integer) CASCADE;
2016-03-22 13:37:20 EDT [24652-29] fhirbase@fhirbase LOG:  duration: 0.163 ms
2016-03-22 13:37:20 EDT [24652-30] fhirbase@fhirbase LOG:  statement: CREATE OR REPLACE FUNCTION insert_practitioners(_total_count_ integer)
	RETURNS bigint AS $$
	  with first_names_source as (
	    select *, row_number() over () from (
	      select CASE WHEN sex = 'M' THEN 'male' ELSE 'female' END as sex,
	             first_name
	      from first_names
	      order by random()
	      limit _total_count_) _
	  ), last_names_source as (
	    select *, row_number() over () from (
	      select last_name
	      from last_names
	      order by random()
	      limit _total_count_) _
	  ), practitioner_data as (
	    select *
	    from first_names_source
	    join last_names_source using (row_number)
	  ), inserted as (
	    INSERT into practitioner (id, version_id, resource)
	    SELECT obj->>'id', obj#>>'{meta,versionId}', obj
	    FROM (
	      SELECT
	        json_build_object(
	         'resourceType', 'Practitioner',
	         'id', gen_random_uuid(),
	         'name', ARRAY[
	           json_build_object(
	            'given', ARRAY[first_name],
	            'family', ARRAY[last_name]
	           )
	         ]
	        )::jsonb as obj
	        FROM practitioner_data
	    ) _
	    RETURNING id
	  )
	  select count(*) from practitioner_data;
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-31] fhirbase@fhirbase ERROR:  relation "practitioner" does not exist at character 655
2016-03-22 13:37:20 EDT [24652-32] fhirbase@fhirbase STATEMENT:  CREATE OR REPLACE FUNCTION insert_practitioners(_total_count_ integer)
	RETURNS bigint AS $$
	  with first_names_source as (
	    select *, row_number() over () from (
	      select CASE WHEN sex = 'M' THEN 'male' ELSE 'female' END as sex,
	             first_name
	      from first_names
	      order by random()
	      limit _total_count_) _
	  ), last_names_source as (
	    select *, row_number() over () from (
	      select last_name
	      from last_names
	      order by random()
	      limit _total_count_) _
	  ), practitioner_data as (
	    select *
	    from first_names_source
	    join last_names_source using (row_number)
	  ), inserted as (
	    INSERT into practitioner (id, version_id, resource)
	    SELECT obj->>'id', obj#>>'{meta,versionId}', obj
	    FROM (
	      SELECT
	        json_build_object(
	         'resourceType', 'Practitioner',
	         'id', gen_random_uuid(),
	         'name', ARRAY[
	           json_build_object(
	            'given', ARRAY[first_name],
	            'family', ARRAY[last_name]
	           )
	         ]
	        )::jsonb as obj
	        FROM practitioner_data
	    ) _
	    RETURNING id
	  )
	  select count(*) from practitioner_data;
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-33] fhirbase@fhirbase LOG:  statement: DROP FUNCTION IF EXISTS insert_patients(_total_count_ integer) CASCADE;
2016-03-22 13:37:20 EDT [24652-34] fhirbase@fhirbase LOG:  duration: 0.141 ms
2016-03-22 13:37:20 EDT [24652-35] fhirbase@fhirbase LOG:  statement: CREATE OR REPLACE FUNCTION insert_patients(_total_count_ integer)
	RETURNS bigint AS $$
	  with first_names_source as (
	    select CASE WHEN sex = 'M' THEN 'male' ELSE 'female' END as sex,
	           first_name,
	           row_number() over ()
	    from first_names
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from first_names)::float)::integer)
	    order by random()
	  ), last_names_source as (
	    select last_name, row_number() over ()
	    from last_names
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from last_names)::float)::integer)
	    order by random()
	  ), street_names_source as (
	    select street_name, row_number() over ()
	    from street_names
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from street_names)::float)::integer)
	    order by random()
	  ), cities_source as (
	    select city, zip, state, row_number() over ()
	    from cities
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from cities)::float)::integer)
	    order by random()
	  ), languages_source as (
	    select code as language_code,
	           name as language_name,
	           row_number() over ()
	    from languages
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from languages)::float)::integer)
	    order by random()
	  ), organizations_source as (
	    select id as organization_id,
	           resource#>>'{name}' as organization_name,
	           row_number() over ()
	    from organization
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from organization)::float)::integer)
	    order by random()
	  ), patient_data as (
	    select
	      *,
	      random_date() as birth_date,
	      random_phone() as phone
	    from first_names_source
	    join last_names_source using (row_number)
	    join street_names_source using (row_number)
	    join cities_source using (row_number)
	    join languages_source using (row_number)
	    join organizations_source using (row_number)
	  ), inserted as (
	    INSERT into patient (id, version_id, resource)
	    SELECT obj->>'id', obj#>>'{meta,versionId}', obj
	    FROM (
	      SELECT
	        json_build_object(
	         'resourceType', 'Patient',
	         'id', gen_random_uuid(),
	         'meta', json_build_object(
	            'versionId', gen_random_uuid(),
	            'lastUpdated', CURRENT_TIMESTAMP
	          ),
	         'gender', sex,
	         'birthDate', birth_date,
	         'active', TRUE,
	         'name', ARRAY[
	           json_build_object(
	            'given', ARRAY[first_name],
	            'family', ARRAY[last_name]
	           )
	         ],
	         'telecom', ARRAY[
	           json_build_object(
	            'system', 'phone',
	            'value', phone,
	            'use', 'home'
	           )
	         ],
	         'address', make_address(street_name, zip, city, state),
	         'communication', ARRAY[
	           json_build_object(
	             'language',
	             json_build_object(
	               'coding', ARRAY[
	                 json_build_object(
	                   'system', 'urn:ietf:bcp:47',
	                   'code', language_code,
	                   'display', language_name
	                 )
	               ],
	               'text', language_name
	             ),
	             'preferred', TRUE
	           )
	         ],
	         'identifier', ARRAY[
	           json_build_object(
	             'use', 'usual',
	             'system', 'urn:oid:2.16.840.1.113883.2.4.6.3',
	             'value', random(6000000, 100000000)::text
	           ),
	           json_build_object(
	             'use', 'usual',
	             'system', 'urn:oid:1.2.36.146.595.217.0.1',
	             'value', random(6000000, 100000000)::text,
	             'label', 'MRN'
	           )
	         ],
	         'managingOrganization', json_build_object(
	           'reference', 'Organization/' || organization_id,
	           'display', organization_name
	         )
	        )::jsonb as obj
	        FROM patient_data
	        LIMIT _total_count_
	    ) _
	    RETURNING id
	  )
	  select count(*) inserted;
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-36] fhirbase@fhirbase ERROR:  relation "organization" does not exist at character 1930
2016-03-22 13:37:20 EDT [24652-37] fhirbase@fhirbase STATEMENT:  CREATE OR REPLACE FUNCTION insert_patients(_total_count_ integer)
	RETURNS bigint AS $$
	  with first_names_source as (
	    select CASE WHEN sex = 'M' THEN 'male' ELSE 'female' END as sex,
	           first_name,
	           row_number() over ()
	    from first_names
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from first_names)::float)::integer)
	    order by random()
	  ), last_names_source as (
	    select last_name, row_number() over ()
	    from last_names
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from last_names)::float)::integer)
	    order by random()
	  ), street_names_source as (
	    select street_name, row_number() over ()
	    from street_names
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from street_names)::float)::integer)
	    order by random()
	  ), cities_source as (
	    select city, zip, state, row_number() over ()
	    from cities
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from cities)::float)::integer)
	    order by random()
	  ), languages_source as (
	    select code as language_code,
	           name as language_name,
	           row_number() over ()
	    from languages
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from languages)::float)::integer)
	    order by random()
	  ), organizations_source as (
	    select id as organization_id,
	           resource#>>'{name}' as organization_name,
	           row_number() over ()
	    from organization
	    cross join generate_series(0, ceil(_total_count_::float
	                                       / (select count(*)
	                                          from organization)::float)::integer)
	    order by random()
	  ), patient_data as (
	    select
	      *,
	      random_date() as birth_date,
	      random_phone() as phone
	    from first_names_source
	    join last_names_source using (row_number)
	    join street_names_source using (row_number)
	    join cities_source using (row_number)
	    join languages_source using (row_number)
	    join organizations_source using (row_number)
	  ), inserted as (
	    INSERT into patient (id, version_id, resource)
	    SELECT obj->>'id', obj#>>'{meta,versionId}', obj
	    FROM (
	      SELECT
	        json_build_object(
	         'resourceType', 'Patient',
	         'id', gen_random_uuid(),
	         'meta', json_build_object(
	            'versionId', gen_random_uuid(),
	            'lastUpdated', CURRENT_TIMESTAMP
	          ),
	         'gender', sex,
	         'birthDate', birth_date,
	         'active', TRUE,
	         'name', ARRAY[
	           json_build_object(
	            'given', ARRAY[first_name],
	            'family', ARRAY[last_name]
	           )
	         ],
	         'telecom', ARRAY[
	           json_build_object(
	            'system', 'phone',
	            'value', phone,
	            'use', 'home'
	           )
	         ],
	         'address', make_address(street_name, zip, city, state),
	         'communication', ARRAY[
	           json_build_object(
	             'language',
	             json_build_object(
	               'coding', ARRAY[
	                 json_build_object(
	                   'system', 'urn:ietf:bcp:47',
	                   'code', language_code,
	                   'display', language_name
	                 )
	               ],
	               'text', language_name
	             ),
	             'preferred', TRUE
	           )
	         ],
	         'identifier', ARRAY[
	           json_build_object(
	             'use', 'usual',
	             'system', 'urn:oid:2.16.840.1.113883.2.4.6.3',
	             'value', random(6000000, 100000000)::text
	           ),
	           json_build_object(
	             'use', 'usual',
	             'system', 'urn:oid:1.2.36.146.595.217.0.1',
	             'value', random(6000000, 100000000)::text,
	             'label', 'MRN'
	           )
	         ],
	         'managingOrganization', json_build_object(
	           'reference', 'Organization/' || organization_id,
	           'display', organization_name
	         )
	        )::jsonb as obj
	        FROM patient_data
	        LIMIT _total_count_
	    ) _
	    RETURNING id
	  )
	  select count(*) inserted;
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-38] fhirbase@fhirbase LOG:  statement: DROP FUNCTION IF EXISTS insert_encounters() CASCADE;
2016-03-22 13:37:20 EDT [24652-39] fhirbase@fhirbase LOG:  duration: 0.138 ms
2016-03-22 13:37:20 EDT [24652-40] fhirbase@fhirbase LOG:  statement: CREATE OR REPLACE FUNCTION insert_encounters()
	RETURNS bigint AS $$
	  WITH patients_ids_source as (
	    SELECT id as patient_id,
	           row_number() over ()
	      FROM patient
	
	    UNION ALL
	
	    SELECT patient_id, row_number() over ()
	    FROM (SELECT id as patient_id
	          FROM patient order by random()
	          LIMIT (select count(*) from patient) / 3) _
	  ), practitioners_source AS (
	    SELECT id as practitioner_id,
	           row_number() OVER ()
	    FROM practitioner
	    CROSS JOIN generate_series(0, ceil((select count(*) from patients_ids_source)::float
	                                       / (select count(*)
	                                          from practitioner)::float)::integer)
	    ORDER by random()
	  ), encounter_data as (
	    SELECT *,
	           random_elem(ARRAY['inpatient',
	                             'outpatient',
	                             'ambulatory',
	                             'emergency']) as class,
	           random_elem(ARRAY['in-progress',
	                             'planned',
	                             'arrived',
	                             'onleave',
	                             'cancelled',
	                             'finished']) as status
	    FROM patients_ids_source
	    JOIN practitioners_source using (row_number)
	  ), inserted as (
	    INSERT into encounter (id, version_id, resource)
	    SELECT obj->>'id', obj#>>'{meta,versionId}', obj
	    FROM (
	      SELECT
	        json_build_object(
	         'resourceType', 'Encounter',
	         'id', gen_random_uuid(),
	         'status', status,
	         'class', class,
	         'patient', json_build_object(
	           'reference', 'Patient/' || patient_id
	         ),
	         'participant', ARRAY[
	           json_build_object(
	             'individual', json_build_object(
	               'reference', 'Practitioner/' || practitioner_id
	             )
	           )
	         ]
	        )::jsonb as obj
	        FROM encounter_data
	    ) _
	    RETURNING id
	  )
	  SELECT 42::bigint;
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-41] fhirbase@fhirbase ERROR:  relation "patient" does not exist at character 173
2016-03-22 13:37:20 EDT [24652-42] fhirbase@fhirbase STATEMENT:  CREATE OR REPLACE FUNCTION insert_encounters()
	RETURNS bigint AS $$
	  WITH patients_ids_source as (
	    SELECT id as patient_id,
	           row_number() over ()
	      FROM patient
	
	    UNION ALL
	
	    SELECT patient_id, row_number() over ()
	    FROM (SELECT id as patient_id
	          FROM patient order by random()
	          LIMIT (select count(*) from patient) / 3) _
	  ), practitioners_source AS (
	    SELECT id as practitioner_id,
	           row_number() OVER ()
	    FROM practitioner
	    CROSS JOIN generate_series(0, ceil((select count(*) from patients_ids_source)::float
	                                       / (select count(*)
	                                          from practitioner)::float)::integer)
	    ORDER by random()
	  ), encounter_data as (
	    SELECT *,
	           random_elem(ARRAY['inpatient',
	                             'outpatient',
	                             'ambulatory',
	                             'emergency']) as class,
	           random_elem(ARRAY['in-progress',
	                             'planned',
	                             'arrived',
	                             'onleave',
	                             'cancelled',
	                             'finished']) as status
	    FROM patients_ids_source
	    JOIN practitioners_source using (row_number)
	  ), inserted as (
	    INSERT into encounter (id, version_id, resource)
	    SELECT obj->>'id', obj#>>'{meta,versionId}', obj
	    FROM (
	      SELECT
	        json_build_object(
	         'resourceType', 'Encounter',
	         'id', gen_random_uuid(),
	         'status', status,
	         'class', class,
	         'patient', json_build_object(
	           'reference', 'Patient/' || patient_id
	         ),
	         'participant', ARRAY[
	           json_build_object(
	             'individual', json_build_object(
	               'reference', 'Practitioner/' || practitioner_id
	             )
	           )
	         ]
	        )::jsonb as obj
	        FROM encounter_data
	    ) _
	    RETURNING id
	  )
	  SELECT 42::bigint;
	$$ LANGUAGE SQL;
2016-03-22 13:37:20 EDT [24652-43] fhirbase@fhirbase LOG:  statement: DROP FUNCTION IF EXISTS generate(_number_of_patients_ integer,
	                                 _number_of_practitioners_ integer,
	                                 _rand_seed_ float) CASCADE;
2016-03-22 13:37:20 EDT [24652-44] fhirbase@fhirbase LOG:  duration: 0.145 ms
2016-03-22 13:37:20 EDT [24652-45] fhirbase@fhirbase LOG:  statement: CREATE OR REPLACE FUNCTION generate(_number_of_patients_ integer,
	                                    _number_of_practitioners_ integer,
	                                    _rand_seed_ float)
	RETURNS bigint AS $$
	  BEGIN
	    TRUNCATE TABLE organization, organization_history,
	                   encounter, encounter_history,
	                   practitioner, practitioner_history,
	                   patient, patient_history;
	    PERFORM insert_organizations();
	    PERFORM insert_practitioners(_number_of_practitioners_);
	    PERFORM insert_patients(_number_of_patients_);
	    PERFORM insert_encounters();
	  RETURN (SELECT count(*) FROM patient);
	  END
	$$ LANGUAGE plpgsql;
2016-03-22 13:37:20 EDT [24652-46] fhirbase@fhirbase LOG:  duration: 1.272 ms
2016-03-22 13:37:20 EDT [24662-1] fhirbase@fhirbase LOG:  statement: SET search_path TO perf;
2016-03-22 13:37:20 EDT [24662-2] fhirbase@fhirbase LOG:  duration: 0.155 ms
2016-03-22 13:37:20 EDT [24662-3] fhirbase@fhirbase LOG:  statement: SET plv8.start_proc = 'plv8_init';
2016-03-22 13:37:20 EDT [24662-4] fhirbase@fhirbase LOG:  duration: 0.112 ms
2016-03-22 13:37:20 EDT [24662-5] fhirbase@fhirbase LOG:  statement: SELECT generate(1000, 200, 0.21);
2016-03-22 13:37:20 EDT [24662-6] fhirbase@fhirbase ERROR:  relation "organization" does not exist
2016-03-22 13:37:20 EDT [24662-7] fhirbase@fhirbase CONTEXT:  SQL statement "TRUNCATE TABLE organization, organization_history,
	                   encounter, encounter_history,
	                   practitioner, practitioner_history,
	                   patient, patient_history"
	PL/pgSQL function generate(integer,integer,double precision) line 3 at SQL statement
2016-03-22 13:37:20 EDT [24662-8] fhirbase@fhirbase STATEMENT:  SELECT generate(1000, 200, 0.21);
2016-03-22 13:37:20 EDT [24672-1] fhirbase@fhirbase LOG:  statement: SET search_path TO perf;
2016-03-22 13:37:20 EDT [24672-2] fhirbase@fhirbase LOG:  duration: 0.146 ms
2016-03-22 13:37:20 EDT [24672-3] fhirbase@fhirbase LOG:  statement: SET plv8.start_proc = 'plv8_init';
2016-03-22 13:37:20 EDT [24672-4] fhirbase@fhirbase LOG:  duration: 0.120 ms
2016-03-22 13:37:20 EDT [24672-5] fhirbase@fhirbase LOG:  statement: SELECT fhir_conformance('{"somekey": "somevalue"}'::json);
2016-03-22 13:37:20 EDT [24672-6] fhirbase@fhirbase ERROR:  function fhir_conformance(json) does not exist at character 8
2016-03-22 13:37:20 EDT [24672-7] fhirbase@fhirbase HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
2016-03-22 13:37:20 EDT [24672-8] fhirbase@fhirbase STATEMENT:  SELECT fhir_conformance('{"somekey": "somevalue"}'::json);
