- hosts: app
  gather_facts: True
  tasks:

  - name: Backup PostgreSQl log file
    shell: cp "{{ postgres.log }}" "{{ postgres.log }}_{{ timestamp }}"
    sudo_user: "{{ postgres.system_user }}"

  - name: Truncate PostgreSQl log file
    shell: echo > "{{ postgres.log }}"
    sudo_user: "{{ postgres.system_user }}"

  - name: PostgreSQl restart
    service: name=postgresql state=restarted
    sudo_user: root

  - name: Remove fhirbase folder
    file: path="{{ fhirbase.app_dir }}" state=absent
    sudo_user: root

  - name: Remove fhirbase documentation folder
    file: path="{{ fhirbase.doc_dir }}" state=absent
    sudo_user: root

  - name: Create fhirbase folder
    file:
      path: "{{ fhirbase.app_dir }}"
      mode: 0755
      owner: "{{ os.user.name }}"
      group: "{{ os.user.name }}"
      state: directory
    sudo_user: root

  - name: Create fhirbase documentation folder
    file:
      path: "{{ fhirbase.doc_dir }}"
      mode: 0755
      owner: "{{ os.user.name }}"
      group: "{{ os.user.name }}"
      state: directory
    sudo_user: root

  - name: Clone Fhirbase project
    shell:
      git clone
          git@github_fhirbase_plv8:fhirbase/fhirbase-plv8.git
          {{ fhirbase.app_dir }}
      && cd {{ fhirbase.app_dir }}
      && git submodule update --init --recursive
    # become: yes
    # become_user: "{{ os.user.name }}"
    sudo_user: "{{ os.user.name }}"

  - name: Clone Fhirbase documentation project
    shell:
      git clone
          git@github_fhirbase_documentation:fhirbase/fhirbase.github.io.git
         {{ fhirbase.doc_dir }}
      && cd {{ fhirbase.doc_dir }}
      && git submodule update --init --recursive
    # become: yes
    # become_user: "{{ os.user.name }}"
    sudo_user: "{{ os.user.name }}"

  - name: Daemonizing Fhirbase performance tests and not waiting for exit
    shell: |
      su {{ os.user.name }} \
         --shell=/bin/bash \
         --command="{{ fhirbase.app_dir }}/perf/perf \
                    --createdb \
                    --dropdb \
                    --number-of-patients=1000 \
                    --pgdatabase={{ postgres.database }} \
                    --pgpassword={{ postgres.password }} \
                    --pguser={{ postgres.user }} \
                    --verbose=3" \
      && cat "{{ postgres.log }}" \
         | sed '0,/^.*Performance tests results are below.*$/d' \
               > "{{ fhirbase.app_dir }}/perf/perf.log" \
      && chown "{{ os.user.name }}":"{{ os.user.name }}" \
               "{{ fhirbase.app_dir }}/perf/perf.log" \
      && su {{ os.user.name }} \
          --shell=/bin/bash \
          --command="cd {{ fhirbase.app_dir }} \
                     && git add perf/perf.log \
                     && git commit --message='{{ git.commit.message }}' \
                     && git push origin {{ git.branch }}"

      get_duration () {
        local statement="$1"
        local description="$2"
        local duration="$( \
          cat "{{ fhirbase.app_dir }}/perf/perf.log" \
          | tr '\n' '\r' \
          | sed -n "s/.*${statement}.*\r.*duration: \([0-9a-z. ]*\).*/\1/p" \
        )"
        printf "  - description: '$description'\n    time: '$duration'\n"
      }

      echo 'operations:' > "{{ fhirbase.doc_dir }}/_data/performance2.yml" \
      && echo "$(get_duration 'SELECT fhir_conformance' 'FHIR conformance')" \
              >> "{{ fhirbase.doc_dir }}/_data/performance2.yml" \
      && chown "{{ os.user.name }}":"{{ os.user.name }}" \
               "{{ fhirbase.doc_dir }}/_data/performance2.yml" \
      && su {{ os.user.name }} \
          --shell=/bin/bash \
          --command="cd {{ fhirbase.doc_dir }} \
                     && git add _data/performance2.yml \
                     && git commit --message='{{ git.commit.message }}' \
                     && git push origin {{ git.branch }}"

      shutdown -h now
    args:
      executable: /bin/bash
    async: 900
    poll: 0
    sudo_user: root
